---
title: "Data Preparation"
author: "Daniel Ahn"
date: "2024-03-21"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, we load in the necessary libraries in R.

```{r library}
library(tidyverse)
library(survival)
library(cmprsk)
library(survminer)
library(lubridate)
library(MatchIt)
library(Matching)
library(rgenoud)
library(optmatch)
library(devtools)
library(survAUC)
library(Hmisc)
library(riskRegression)
library(pec)
library(boot)
library(compareC)
library(coin)
library(etm)
library(table1)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(cowplot)
library(coxme)
library(cobalt)
library(transplantr)
library(dplyr)
library(purrr)
library(risksetROC)
library(insurancerating)
library(data.table)
library(rsample)
library(rms)
```

# Data Sources

We uploaded all the necessary files from the SRTR Standard Analysis Files (2023 Q3).

```{r data_read_in}

#information about candidates added to the liver waitlist. 
cand_liinq3 <- read_sas("cand_liinq3.sas7bdat", NULL)

#information about MELD exceptions that have been submitted
mpexceptq3 <- read_sas("mpexceptq3.sas7bdat", NULL)

#all status updates throughout a candidate's time spent on the liver transplant waitlist
stathist_liinq3 <- read_sas("stathist_liinq3.sas7bdat", NULL)

#information about all liver transplant recipients
tx_liq3 <- read_sas("tx_liq3.sas7bdat", NULL)

#all transplant centers
institutionq3 <- read_sas("institutionq3.sas7bdat", NULL)

```

# Data Cleaning

```{r data_cleaning}

candliverset <- cand_liinq3

candliverset1 <- filter(candliverset, candliverset$WL_ORG == "LI" & (candliverset$CAN_LISTING_DT >= as.POSIXct("2002-02-27")))

#I made another variable called age-group to separate candidates based on age at listing.
candliverset1 <- candliverset1 %>%
  mutate(
    AGE_GROUP = case_when(
      CAN_AGE_AT_LISTING < 12 ~ 0,
      (CAN_AGE_AT_LISTING >= 12 & CAN_AGE_AT_LISTING < 18) ~ 1,
      CAN_AGE_AT_LISTING >= 18 ~ 2
    )
  )

adultlivers <- filter(candliverset1, AGE_GROUP == 2)

#this code sets time range for our cohort and excludes people listed as Status 1 initially or as inactivated.
practiceset <- filter(adultlivers, (adultlivers$CAN_LISTING_DT >= as.POSIXct("2016-06-01") & 
                                    adultlivers$CAN_LISTING_DT <= as.POSIXct("2022-04-30"))) %>%
               filter(CAN_INIT_ACT_STAT_CD != 6010 &
                      CAN_INIT_ACT_STAT_CD != 6011 & 
                      CAN_INIT_ACT_STAT_CD != 6012 & 
                      CAN_INIT_ACT_STAT_CD != 6030 & 
                      CAN_INIT_ACT_STAT_CD != 6040 &
                      CAN_INIT_ACT_STAT_CD != 6999)

#merge the above dataset with mpexcept, which contains information about all submitted MELD exception applications
practiceset1 <- merge(x = practiceset, y = mpexceptq3, by = "PX_ID", all.x = TRUE) %>%
  group_by(PX_ID) %>% arrange(CAN_LISTING_DT) 

#Filters for all patients who had at least one exception application submitted. Orders observations by date of exception application submission. Creates new variable EXC that equals 1 when a patient has an accepted standardized MELD exception (CANHX_MPXCPT_DGN = 9 and/or 3 refers to non-standardized).
x1 <- practiceset1 %>% filter(any(!is.na(CANHX_MPXCPT_CASE_ID))) %>% arrange(CANHX_MPXCPT_BEGIN_DT) %>%
  mutate(EXC = case_when(
    ((CANHX_MPXCPT_DGN != 9 & CANHX_MPXCPT_DGN != 3) & (CANHX_MPXCPT_STAT == 5 | CANHX_MPXCPT_STAT == 10 | CANHX_MPXCPT_STAT == 14 | CANHX_MPXCPT_STAT == 16 | CANHX_MPXCPT_STAT == 18 | CANHX_MPXCPT_STAT == 30)) ~ 1,
    TRUE ~ 0
  )) %>% filter(any(EXC == 1)) 

#identify first observation per patient in which standardized MELD exception is registered to start.
i1 <- setDT(x1)[(CANHX_MPXCPT_DGN != 9 & CANHX_MPXCPT_DGN != 3), .(colindex = .I[1]), PX_ID]$colindex
x1.0 <- x1[i1] %>% mutate(TIME_TO_SE = as.numeric(difftime(CANHX_MPXCPT_BEGIN_DT, CAN_LISTING_DT, units = "days")),
                          TIME_SE_TO_REM = as.numeric(difftime(CAN_REM_DT, CANHX_MPXCPT_BEGIN_DT, units = "days"))) %>%
  filter(TIME_TO_SE > 0) %>% filter(TIME_SE_TO_REM > 0)

x1.0$CAN_REM_CD <- x1.0$CAN_REM_CD * 0
x1.0 <- x1.0 %>% dplyr::select(-c("CAN_REM_DT"))
x1.0 <- rename(x1.0, CAN_REM_DT = CANHX_MPXCPT_BEGIN_DT)
x1.0 <- x1.0 %>% dplyr::select("PX_ID", "PERS_ID", "REC_TX_DT", "CAN_REM_DT", "CAN_REM_CD", "CAN_REM_COD", "CAN_LISTING_DT", "CAN_DEATH_DT", "PERS_OPTN_DEATH_DT", "PERS_SSA_DEATH_DT", "CAN_MED_COND", "CAN_INIT_ACT_STAT_DT", "CAN_AGE_AT_LISTING", "CAN_INIT_ACT_STAT_CD", "CAN_INIT_SRTR_LAB_MELD", "CAN_LAST_STAT", "CAN_LAST_ACT_STAT_DT", "CAN_LISTING_CTR_ID", "CAN_DGN", "CAN_DGN_OSTXT", "CAN_GENDER", "CAN_ABO", "CAN_RACE", "CAN_FUNCTN_STAT", "CAN_AGE_IN_MONTHS_AT_LISTING", "CAN_PRIMARY_PAY")

x1.1 <- practiceset1 %>% filter(any(!is.na(CANHX_MPXCPT_CASE_ID))) %>% 
  mutate(EXC = case_when(
    ((CANHX_MPXCPT_DGN != 9 & CANHX_MPXCPT_DGN != 3) & (CANHX_MPXCPT_STAT == 5 | CANHX_MPXCPT_STAT == 10 | CANHX_MPXCPT_STAT == 14 | CANHX_MPXCPT_STAT == 16 | CANHX_MPXCPT_STAT == 18 | CANHX_MPXCPT_STAT == 30)) ~ 1,
    TRUE ~ 0
  )) %>% filter(!any(EXC == 1)) %>% filter(row_number() == 1) %>%
  dplyr::select("PX_ID", "PERS_ID", "REC_TX_DT", "CAN_REM_DT", "CAN_REM_CD", 
                "CAN_REM_COD", "CAN_LISTING_DT", "CAN_DEATH_DT",
                "PERS_OPTN_DEATH_DT", "PERS_SSA_DEATH_DT", "CAN_MED_COND", "CAN_INIT_ACT_STAT_DT", 
                "CAN_AGE_AT_LISTING", "CAN_INIT_ACT_STAT_CD", "CAN_INIT_SRTR_LAB_MELD",
                "CAN_LAST_STAT", "CAN_LAST_ACT_STAT_DT", "CAN_LISTING_CTR_ID",
                "CAN_DGN", "CAN_DGN_OSTXT", "CAN_GENDER", "CAN_ABO", "CAN_RACE",
                "CAN_FUNCTN_STAT", "CAN_AGE_IN_MONTHS_AT_LISTING", "CAN_PRIMARY_PAY")

x2 <- practiceset1 %>% filter(all(is.na(CANHX_MPXCPT_CASE_ID))) %>% mutate(EXC = 0) %>%
  dplyr::select("PX_ID", "PERS_ID", "REC_TX_DT", "CAN_REM_DT", "CAN_REM_CD", 
                "CAN_REM_COD", "CAN_LISTING_DT", "CAN_DEATH_DT",
                "PERS_OPTN_DEATH_DT", "PERS_SSA_DEATH_DT", "CAN_MED_COND", "CAN_INIT_ACT_STAT_DT", 
                "CAN_AGE_AT_LISTING", "CAN_INIT_ACT_STAT_CD", "CAN_INIT_SRTR_LAB_MELD",
                "CAN_LAST_STAT", "CAN_LAST_ACT_STAT_DT", "CAN_LISTING_CTR_ID",
                "CAN_DGN", "CAN_DGN_OSTXT", "CAN_GENDER", "CAN_ABO", "CAN_RACE",
                "CAN_FUNCTN_STAT", "CAN_AGE_IN_MONTHS_AT_LISTING", "CAN_PRIMARY_PAY")

p1 <- rbind(x1.0, x1.1, x2)

#x1 <- x1 %>% dplyr::select("PX_ID", "CANHX_MPXCPT_DGN", "CANHX_MPXCPT_STAT", "EXC")
  
multi_recips <- tx_liq3 %>% filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% dplyr::select(PX_ID, REC_TX_TY)

#number of multi-organ recipients
n_mults <- nrow(p1 %>% filter(PX_ID %in% multi_recips$PX_ID))
p1 <- p1 %>% filter(!PX_ID %in% multi_recips$PX_ID)

#exclude them from the init_list because we don't actually care
# <- init_list %>% filter(!PX_ID %in% multi_recips$PX_ID)

#following code is to exclude patients with multiple listings at different transplant centers simultaneously and to combine registrations for people who were transferred.

nomultiplelisting <- p1 %>% group_by(PERS_ID) %>% arrange(CAN_LISTING_DT) %>% filter(n() == 1)

multA <- p1 %>% group_by(PERS_ID) %>% arrange(CAN_LISTING_DT) %>% filter(n() == 2) %>%
  mutate(Int = interval(CAN_LISTING_DT, CAN_REM_DT),
         OVERLAPPING = map(seq_along(Int), function(x){
           y = setdiff(seq_along(Int), x)
           return(any(int_overlaps(Int[x], Int[y])))}),
         TRANSFER = case_when(
           any(CAN_REM_CD == 7) ~ 1,
           all(CAN_REM_CD != 7) ~ 2,
           TRUE ~ 3)) %>% filter(OVERLAPPING == FALSE)

#does not count

multA1 <- multA %>% filter(any(CAN_REM_CD == 7)) %>% 
  mutate(CAN_REM_DT = replace(CAN_REM_DT, 1, last(CAN_REM_DT)),
         CAN_REM_CD = replace(CAN_REM_CD, 1, last(CAN_REM_CD))) %>% 
  slice_head(n = 1) %>% dplyr::select(-c("TRANSFER"))

#31

multA2 <- multA %>% filter(TRANSFER != 1) %>% dplyr::select(-c("TRANSFER"))

multB <- p1 %>% group_by(PERS_ID) %>% arrange(CAN_LISTING_DT) %>% filter(n() == 2) %>%
  mutate(Int = interval(CAN_LISTING_DT, CAN_REM_DT),
         OVERLAPPING = map(seq_along(Int), function(x){
           y = setdiff(seq_along(Int), x)
           return(any(int_overlaps(Int[x], Int[y])))}),
         TRANSFER = case_when(
           any(CAN_REM_CD == 7) ~ 1,
           all(CAN_REM_CD != 7) ~ 2,
           TRUE ~ 3)) %>% filter(OVERLAPPING == TRUE)

#does not count

multB1 <- multB %>% filter(any(CAN_REM_CD == 7)) %>% 
  mutate(CAN_REM_DT = replace(CAN_REM_DT, 1, last(CAN_REM_DT)),
         CAN_REM_CD = replace(CAN_REM_CD, 1, last(CAN_REM_CD))) %>% slice_head(n = 1)

multB2 <- multB %>% filter(TRANSFER != 1)

#does not count

multB2.1 <- multB2 %>% filter(any(CAN_REM_CD == 14)) %>% filter(any(CAN_REM_CD == 15)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 15)

multB2.2 <- multB2 %>% filter(any(CAN_REM_CD == 14)) %>% filter(any(CAN_REM_CD == 4)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 4)

multB2.3 <- multB2 %>% filter(any(CAN_REM_CD == 14)) %>% filter(!any(CAN_REM_CD == 14) & !any(CAN_REM_CD == 4))

multB3 <- multB %>% filter(!any(CAN_REM_CD == 14) & !(any(CAN_REM_CD == 7)))

#does not count

multB3.1 <- multB3 %>% filter(any(CAN_REM_CD == 4)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 4)

multB3.2 <- multB3 %>% filter(any(CAN_REM_CD == 15)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 15)

multB3.3 <- multB3 %>% filter(any(CAN_REM_CD == 21)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 21)

multB3.4 <- multB3 %>% filter(!any(CAN_REM_CD == 15) & !any(CAN_REM_CD == 4) & !any(CAN_REM_CD == 21)) %>% 
  mutate(across(c("CAN_LISTING_DT"), first)) %>% ungroup() %>% group_by(PERS_ID) %>% arrange(CAN_REM_DT) %>% 
  mutate(across(c("CAN_REM_DT"), last)) %>% filter(row_number() == 1)

multi <- p1 %>% group_by(PERS_ID) %>% arrange(CAN_LISTING_DT) %>% filter(n() == 3) %>%
  mutate(Int = interval(CAN_LISTING_DT, CAN_REM_DT),
         OVERLAPPING = map(seq_along(Int), function(x){
           y = setdiff(seq_along(Int), x)
           return(any(int_overlaps(Int[x], Int[y])))
         }))

#does not count
         
multiA <- multi %>% filter(all(OVERLAPPING == FALSE))

multiB <- multi %>% filter(!all(OVERLAPPING == FALSE) & !all(OVERLAPPING == TRUE)) 

#does not count

multiB1 <- multiB %>% filter(OVERLAPPING == FALSE)

multiB2 <- multiB %>% filter(OVERLAPPING != FALSE) %>% filter(any(CAN_REM_CD == 7)) %>% 
  mutate(CAN_REM_DT = replace(CAN_REM_DT, 1, last(CAN_REM_DT)),
         CAN_REM_CD = replace(CAN_REM_CD, 1, last(CAN_REM_CD))) %>% slice_head(n = 1)

multiB3 <- multiB %>% filter(any(CAN_REM_CD == 14)) %>% filter(any(CAN_REM_CD == 15)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 15)

multiB4 <- multiB %>% filter(any(CAN_REM_CD == 14)) %>% filter(any(CAN_REM_CD == 4)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 4)

multiB5 <- multiB %>% filter(any(CAN_REM_CD == 21)) %>%
  mutate(across(c("CAN_LISTING_DT"), first)) %>% filter(CAN_REM_CD == 21)

multiB6 <- multiB %>% filter(!any(CAN_REM_CD == 15) & !any(CAN_REM_CD == 4) & !any(CAN_REM_CD == 21)) %>% 
  mutate(across(c("CAN_LISTING_DT"), first)) %>% ungroup() %>% group_by(PERS_ID) %>% arrange(CAN_REM_DT) %>% 
  mutate(across(c("CAN_REM_DT"), last)) %>% filter(row_number() == 1)

multiC <- multi %>% filter(all(OVERLAPPING == TRUE)) 

multiC1 <- multiC %>% filter(any(CAN_REM_CD == 4)) %>% mutate(across(c("CAN_LISTING_DT"), first)) %>%
  filter(CAN_REM_CD == 4)

multiC2 <- multiC %>% filter(any(CAN_REM_CD == 15)) %>% mutate(across(c("CAN_LISTING_DT"), first)) %>%
  filter(CAN_REM_CD == 15)

multiC3 <- multiC %>% filter(any(CAN_REM_CD == 21)) %>% mutate(across(c("CAN_LISTING_DT"), first)) %>% 
  filter(CAN_REM_CD == 21)

multiC4 <- multiC %>% filter(!any(CAN_REM_CD == 15) & !any(CAN_REM_CD == 4) & !any(CAN_REM_CD == 21)) %>% 
  mutate(across(c("CAN_LISTING_DT"), first)) %>% ungroup() %>% group_by(PERS_ID) %>% arrange(CAN_REM_DT) %>% 
  mutate(across(c("CAN_REM_DT"), last)) %>% filter(row_number() == 1)
  
multiple <- p1 %>% group_by(PERS_ID) %>% arrange(CAN_LISTING_DT) %>% filter(n() > 3) %>%
  mutate(Int = interval(CAN_LISTING_DT, CAN_REM_DT),
         OVERLAPPING = map(seq_along(Int), function(x){
           y = setdiff(seq_along(Int), x)
           return(any(int_overlaps(Int[x], Int[y])))
         }))

multipleA <- multiple %>% filter(all(OVERLAPPING == FALSE))

multipleB <- multiple %>% filter(!all(OVERLAPPING == TRUE) & !all(OVERLAPPING == FALSE)) 

multipleB1 <- multipleB %>% filter(OVERLAPPING == FALSE)

multipleB2 <- multipleB %>% filter(OVERLAPPING != FALSE) %>% filter(CAN_REM_CD == 4 | CAN_REM_CD == 15)

multipleB3 <- multipleB %>% filter(OVERLAPPING != FALSE) %>% 
  filter(!any(CAN_REM_CD == 15) & !any(CAN_REM_CD == 4) & !any(CAN_REM_CD == 21)) %>% 
  mutate(across(c("CAN_LISTING_DT"), first)) %>% ungroup() %>% group_by(PERS_ID) %>% arrange(CAN_REM_DT) %>% 
  mutate(across(c("CAN_REM_DT"), last)) %>% filter(row_number() == 1)

multipleC <- multiple %>% filter(all(OVERLAPPING == TRUE)) %>% filter(CAN_REM_CD == 4 | CAN_REM_CD == 15)

multiples <- rbind(multA1, multA2, multB1, multB2.1, multB2.2, multB2.3, multB3.1, 
                   multB3.2, multB3.3, multB3.4, multiA, multiB1, multiB2, multiB3, 
                   multiB4, multiB5, multiB6, multiC1, multiC2, multiC3, multiC4, 
                   multipleA, multipleB1, multipleB2, multipleB3, multipleC) %>% 
  dplyr::select(-c("Int", "OVERLAPPING"))

p2 <- rbind(multiples, nomultiplelisting) %>% ungroup()

```

```{r survival analysis set up}
p1 <- p2 %>%
  mutate(
    DEATH_DT = case_when(
      !is.na(PERS_OPTN_DEATH_DT) ~ PERS_OPTN_DEATH_DT,
      is.na(PERS_OPTN_DEATH_DT) & !is.na(PERS_SSA_DEATH_DT) ~ PERS_SSA_DEATH_DT,
      is.na(PERS_OPTN_DEATH_DT) & is.na(PERS_SSA_DEATH_DT) & !is.na(CAN_DEATH_DT) ~ CAN_DEATH_DT 
    )
  )

p1$PRE_TX_DEATH <- ifelse(p1$CAN_REM_CD == 8 | 
                     (p1$CAN_REM_CD == 5 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 6 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 7 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 9 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 10 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 11 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 12 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 13 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 16 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 17 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 20 & !is.na(p1$DEATH_DT)) |
                     (p1$CAN_REM_CD == 24 & !is.na(p1$DEATH_DT)), 1, 0)

p1 <- p1 %>% mutate(PRE_TX_DEATH = ifelse(is.na(PRE_TX_DEATH), 0, PRE_TX_DEATH))

#p1$MULTI_LISTING_DT <- as.Date(p1$MULTI_LISTING_DT, origin = "1970-01-01")

p1$DEATH_DT <- as.Date(p1$DEATH_DT, origin = "1970-01-01")
p1$REC_TX_DT <- as.Date(p1$REC_TX_DT, origin = "1970-01-01")

p1 <- p1 %>% mutate(REMOVAL_DATE = case_when(CAN_REM_CD == 8 |
    (CAN_REM_CD == 5 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 6 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 7 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 9 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 10 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 12 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 13 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 16 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 17 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 20 & !is.na(DEATH_DT)) |
    (CAN_REM_CD == 24 & !is.na(DEATH_DT)) ~ DEATH_DT,
  TRUE ~ CAN_REM_DT))

p1$REMOVAL_DATE <- as.Date(p1$REMOVAL_DATE, origin = "1970-01-01")

p1 <- p1 %>%
  mutate(
    LASTDATE = case_when(
      is.na(REMOVAL_DATE) ~ CAN_LAST_ACT_STAT_DT,
      TRUE ~ REMOVAL_DATE
    )
  )

p1 <- p1 %>%
  mutate(
    REMOVAL_CAUSE = case_when(
      is.na(CAN_REM_CD) ~ 0,
      PRE_TX_DEATH == 1 ~ 1,
      CAN_REM_CD == 4 | CAN_REM_CD == 14 | CAN_REM_CD == 21 ~ 2,
      TRUE ~ 3
    )
  )

p1 <- p1 %>%
  mutate(
    TRANSPLANT = case_when(
      CAN_REM_CD == 4 | CAN_REM_CD == 14 | CAN_REM_CD == 21 ~ 1,
      TRUE ~ 0)
    )

p1 <- p1 %>%
  mutate(
    REMOVALTYPE = case_when(
      (REMOVAL_CAUSE == 0 | REMOVAL_CAUSE == 3) ~ 0,
      REMOVAL_CAUSE == 1 ~ 1,
      REMOVAL_CAUSE == 2 ~ 2
    )
  )

p1 <- p1 %>%
  mutate(
    CENSOR_DT = case_when(
      REMOVAL_CAUSE == 0 ~ CAN_LAST_ACT_STAT_DT,
      REMOVAL_CAUSE == 3 ~ CAN_REM_DT
     ))

p1 <- p1 %>%
  mutate(
    FINAL_REMOVAL_DATE = case_when(
      REMOVALTYPE == 0 ~ CENSOR_DT,
      REMOVALTYPE == 1 ~ DEATH_DT,
      REMOVALTYPE == 2 ~ CAN_REM_DT
    )
  )

p1 <- p1 %>%
  mutate(TIME_TO_REMOVAL = as.numeric(difftime(FINAL_REMOVAL_DATE, CAN_LISTING_DT, units = "days")))

p1 <- p1 %>%
  mutate(TIME_TO_REMOVAL_YEARS = TIME_TO_REMOVAL / 365.25)

p1 <- p1 %>%
  mutate(SURVIVAL_TIME = as.numeric(difftime(LASTDATE, CAN_LISTING_DT, units = "days")))

p1 <- p1 %>%
  mutate(SURVIVAL_TIME_YEARS = SURVIVAL_TIME / 365.25)

p1 <- p1 %>% mutate(
  POLICY_COHORT = case_when(
    (CAN_LISTING_DT >= as.POSIXct("2016-06-01") & CAN_LISTING_DT <= as.POSIXct("2019-04-30")) ~ "Pre-Policy",
    (CAN_LISTING_DT >= as.POSIXct("2019-06-01") & CAN_LISTING_DT <= as.POSIXct("2022-04-30")) ~ "Post-Policy",
    (CAN_LISTING_DT >= as.POSIXct("2019-05-01") & CAN_LISTING_DT <= as.POSIXct("2019-05-31")) ~ "Between"
  )
) %>% ungroup()

institution2023q3 <- institutionq3 %>% 
  rename(CAN_LISTING_CTR_ID = CTR_ID)
p1withregion <- merge(x = p1, y = institution2023q3, by = "CAN_LISTING_CTR_ID", all.x = TRUE)

```

```{r creating time-varying dataset}

practice <- merge(x = p1withregion, y = stathist_liinq3, by = "PX_ID", all.x = TRUE)

practice <- rename(practice, CAN_INIT_ACT_STAT_DT = CAN_INIT_ACT_STAT_DT.x, 
                   CAN_INIT_ACT_STAT_CD = CAN_INIT_ACT_STAT_CD.x, CAN_LAST_STAT = CAN_LAST_STAT.x,
                   CAN_LAST_ACT_STAT_DT = CAN_LAST_ACT_STAT_DT.x, CAN_GENDER = CAN_GENDER.x,
                   CAN_INIT_SRTR_LAB_MELD = CAN_INIT_SRTR_LAB_MELD.x,
                   CAN_REM_DT = CAN_REM_DT.x, 
                   CAN_LISTING_DT = CAN_LISTING_DT.x, CAN_REM_CD = CAN_REM_CD.x)

practice1 <- dplyr::select(practice, "PX_ID", "PERS_ID", "POLICY_COHORT", "REC_TX_DT", "CAN_REM_DT", "CAN_REM_CD", 
                      "CAN_REM_COD", "CAN_LISTING_DT", "CANHX_BEGIN_DT", "CANHX_END_DT", "CAN_DEATH_DT",
                      "PERS_OPTN_DEATH_DT", "PERS_SSA_DEATH_DT", "CANHX_EXC_FLG", "CAN_MED_COND", 
                      "CANHX_EXC_SCORE", "CANHX_EXC_DIAG_OTHER", "CANHX_OPTN_LAB_MELD", 
                      "CANHX_SRTR_LAB_MELD", "CANHX_STAT_CD", "CANHX_MELD_DIFF_REASON_CD", "CANHX_EXC_DIAG_HCC1",
                      "CANHX_EXC_DIAG_HCC2", "CANHX_EXC_DIAG_HCC_NOPOLICY", "CAN_INIT_ACT_STAT_DT", 
                      "CAN_AGE_AT_LISTING", "CAN_INIT_ACT_STAT_CD", "CAN_INIT_SRTR_LAB_MELD",
                      "CAN_LAST_STAT", "CAN_LAST_ACT_STAT_DT", "CAN_LISTING_CTR_ID", "TRANSPLANT",
                      "CAN_DGN", "CAN_DGN_OSTXT", "CAN_GENDER", "CAN_ABO", "CAN_RACE", "REGION",
                      "CAN_FUNCTN_STAT", "CAN_AGE_IN_MONTHS_AT_LISTING", "CAN_PRIMARY_PAY",
                      "DEATH_DT", "PRE_TX_DEATH", "REMOVAL_DATE", "LASTDATE", "REMOVAL_CAUSE", "REMOVALTYPE",
                      "CENSOR_DT", "FINAL_REMOVAL_DATE", "TIME_TO_REMOVAL", "TIME_TO_REMOVAL_YEARS", 
                      "SURVIVAL_TIME", "SURVIVAL_TIME_YEARS", "CANHX_BILI", "CANHX_SERUM_CREAT", "CANHX_DIAL_PRIOR_WEEK",
                      "CANHX_INR", "CANHX_SERUM_SODIUM")

practice1 <- practice1 %>% group_by(PX_ID) %>% arrange(CANHX_BEGIN_DT) %>% mutate(CANHX_DIAL_PRIOR_WEEK = na_if(CANHX_DIAL_PRIOR_WEEK, ""),
                                  CANHX_MELD_DIFF_REASON_CD = ifelse(is.na(CANHX_MELD_DIFF_REASON_CD), 0, CANHX_MELD_DIFF_REASON_CD),
                                  DIALYSIS = case_when(
                                    CANHX_DIAL_PRIOR_WEEK == "N" | CANHX_DIAL_PRIOR_WEEK == "A" ~ 0,
                                    CANHX_DIAL_PRIOR_WEEK == "Y" ~ 1),
                                  MELD_CALC = case_when(
                                    !is.na(CANHX_BILI) & !is.na(CANHX_DIAL_PRIOR_WEEK) ~ round(meld_na(CANHX_INR, CANHX_BILI, CANHX_SERUM_CREAT, CANHX_SERUM_SODIUM, DIALYSIS, units = "US")),
                                    TRUE ~ CANHX_SRTR_LAB_MELD - 6200))
                                
#this code lets us censor patients when they obtain Status 1

status1 <- practice1 %>%
  group_by(PX_ID) %>%
  arrange(PX_ID, CANHX_BEGIN_DT) %>%
  filter(any(CANHX_STAT_CD == 6011)) %>%
  mutate(STATUS1 = as.numeric(row_number() == min(row_number()[CANHX_STAT_CD == 6011]))) %>%
  filter(row_number() <= which.max(STATUS1) | all(STATUS1 == 0)) %>%
  filter(row_number() <= n()-1) %>%
  mutate(PRE_TX_DEATH = ifelse(PRE_TX_DEATH == 1, 0, PRE_TX_DEATH)) %>%
  ungroup()
status1$STATUS1 <- NULL

nonstatus1 <- practice1 %>%
  group_by(PX_ID) %>%
  arrange(PX_ID, CANHX_BEGIN_DT) %>%
  filter(!any(CANHX_STAT_CD == 6011)) %>%
  ungroup()

practice1 <- rbind(status1, nonstatus1) %>% group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT)

practice1 <- practice1 %>%
  mutate(
    EXCEPTION = case_when(
      ((CANHX_MELD_DIFF_REASON_CD == 3 | CANHX_MELD_DIFF_REASON_CD == 7) & CANHX_EXC_FLG == 1) ~ 1,
      TRUE ~ 0),
    ALLOCATION_SCORE = case_when(
      CANHX_STAT_CD == 6999 & ((CANHX_OPTN_LAB_MELD - 6200) > 40) ~ 40,
      CANHX_STAT_CD == 6999 & ((CANHX_OPTN_LAB_MELD - 6200) <= 40) ~ CANHX_OPTN_LAB_MELD - 6200,
      is.na(CANHX_OPTN_LAB_MELD) & !is.na(CANHX_SRTR_LAB_MELD) & ((CANHX_SRTR_LAB_MELD - 6200) <= 40) ~ CANHX_SRTR_LAB_MELD - 6200,
      TRUE ~ CANHX_STAT_CD - 6200),
    LAB_SCORE = case_when(
      (!is.na(CANHX_OPTN_LAB_MELD)) & (CANHX_OPTN_LAB_MELD - 6200 > 40) ~ 40,
      is.na(CANHX_OPTN_LAB_MELD) ~ CANHX_SRTR_LAB_MELD - 6200,
      TRUE ~ CANHX_OPTN_LAB_MELD - 6200))


timeseries <- practice1 %>% group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT) %>%
  mutate(TIME1 = as.numeric(difftime(CANHX_BEGIN_DT, CAN_LISTING_DT, units = "days")),
         TIME2 = as.numeric(difftime(CANHX_END_DT, CAN_LISTING_DT, units = "days")) + 1,
         TIME2 = case_when(
           is.na(TIME2) ~ as.numeric(difftime(LASTDATE, CAN_LISTING_DT, units = "days")),
           TRUE ~ TIME2),
         sex = ifelse(CAN_GENDER == "M", "Male", "Female"),
         sex = factor(sex, levels = c("Male", "Female")),
         race = case_when(
           CAN_RACE == 8 ~ "White",
           CAN_RACE == 16 ~ "Black",
           CAN_RACE == 2000 ~ "Hispanic/Latino",
           CAN_RACE == 64 ~ "Asian",
           TRUE ~ "Other"),
         race = factor(race, levels = c("White", "Black", "Hispanic/Latino", "Asian", "Other")),
         age = CAN_AGE_AT_LISTING,
         functional = case_when(
           (CAN_FUNCTN_STAT == 2010 | CAN_FUNCTN_STAT == 2020 | CAN_FUNCTN_STAT == 2030 | CAN_FUNCTN_STAT == 2040) ~ "Low",
           (CAN_FUNCTN_STAT == 2050 | CAN_FUNCTN_STAT == 2060 | CAN_FUNCTN_STAT == 2070) ~ "Intermediate",
           (CAN_FUNCTN_STAT == 2080 | CAN_FUNCTN_STAT == 2090 | CAN_FUNCTN_STAT == 2100) ~ "High",
           TRUE ~ "Unknown"),
         functional = factor(functional, levels = c("High", "Intermediate", "Low", "Unknown")),
         payor = case_when(
           CAN_PRIMARY_PAY %in% c(2,3,4,5,6,7,13) ~ "Public",
           CAN_PRIMARY_PAY == 1 ~ "Private",
           TRUE ~ "Other"),
         payor = factor(payor, levels = c("Private", "Public", "Other")))

timeseries1 <- timeseries %>% ungroup() %>% mutate(
  DELETE = case_when(
    (TIME1 > TIME2) & is.na(CANHX_END_DT) ~ 1,
    TRUE ~ 0),
  SCORE_DIFFERENCE = case_when(
    EXCEPTION == 1 ~ ALLOCATION_SCORE - LAB_SCORE,
    TRUE ~ 0
  )) %>% subset(DELETE == 0) %>% group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT)

deaths <- timeseries1 %>% filter(any(PRE_TX_DEATH == 1)) %>% 
  filter(row_number() == n()) %>% mutate(NEW_DEATH = 1)
nodeaths <- timeseries1 %>% filter(any(PRE_TX_DEATH == 1)) %>% 
  filter(row_number() != n()) %>% mutate(NEW_DEATH = 0)
nodeaths1 <- timeseries1 %>% filter(!any(PRE_TX_DEATH == 1)) %>% mutate(NEW_DEATH = 0)

timeseries1 <- rbind(deaths, nodeaths, nodeaths1) %>% 
  group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT)

transplants <- timeseries1 %>% filter(any(TRANSPLANT == 1)) %>% 
  filter(row_number() == n()) %>% mutate(TX = 1)
notransplants <- timeseries1 %>% filter(any(TRANSPLANT == 1)) %>% 
  filter(row_number() != n()) %>% mutate(TX = 0)
notransplants1 <- timeseries1 %>% filter(!any(TRANSPLANT == 1)) %>% mutate(TX = 0)

timeseries1 <- rbind(transplants, notransplants, notransplants1) %>%
  group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT) 


timeseries1 <- timeseries1 %>% mutate(REC_EXCEPTION = ifelse((any(EXCEPTION == 1)), 1, 0)) %>% mutate(REC_TX = ifelse((any(TX == 1)), 1, 0)) %>%
  mutate(EXC_WITHIN_WK = case_when(
    any(EXCEPTION == 1 & TIME1 < 8) ~ 1,
    TRUE ~ 0)) 

timeseries1 <- timeseries1 %>% group_by(PX_ID) %>% arrange(PX_ID, CANHX_BEGIN_DT) %>% mutate(Count = n())

exceptionwithinweek <- timeseries1 %>% filter(!any(EXCEPTION == 1 & TIME1 < 8)) %>%
  filter(row_number() == 1)

timeseries2 <- timeseries1 %>% ungroup() %>% group_by(PX_ID) %>% arrange(PX_ID, desc(EXCEPTION), TIME1)

notexceptionwithinweek <- timeseries2 %>% filter(any(EXCEPTION == 1 & TIME1 < 8)) %>% 
  filter(row_number() == 1) 

finaldataset <- rbind(exceptionwithinweek, notexceptionwithinweek)

timeseriesdata <- timeseries1 %>%
  mutate(
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "POLYCYSTIC LIVER DISEASE" |
                        CAN_DGN_OSTXT == "PCLD/PCKD" |
                        CAN_DGN_OSTXT == "POLYCYSTIC LIVER AND KIDNEY DISEASE" |
                        CAN_DGN_OSTXT == "POLYCYSTIC LIVER" | 
                        CAN_DGN_OSTXT == "POLYCYSTIC KIDNEYS" |
                        CAN_DGN_OSTXT == "POLYCYSTIC LIVER / KIDNEY" |
                        CAN_DGN_OSTXT == "POLYCYSTIC KIDNEY DISEASE" |
                        CAN_DGN_OSTXT == "POLYCYSTIC DISEASE" |
                        CAN_DGN_OSTXT == "POLYCYCTIC LIVER" | 
                        CAN_DGN_OSTXT == "AUTOSOMAL DOMINANT POLYCYSTIC LIVER DISEASE?" |  
                        CAN_DGN_OSTXT == "POLYCYSTIC LIVER AND KIDNEY"), 4451, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "NASH" |
                        CAN_DGN_OSTXT == "NAFLD"), 4214, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "CYSTIC FIBROSIS" |
                        CAN_DGN_OSTXT == "CYSTIC FIBROSIS - LIVER"), 4285, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY" |
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGITIS" |
                        CAN_DGN_OSTXT == "DIFFUSE ISCHEMIC CHOLANGIOPATHY" |
                        CAN_DGN_OSTXT == "POST OLT BILIARY STRICTURES" | 
                        CAN_DGN_OSTXT == "ALLOGRAFT FAILURE FROM ISCHEMIC CHOLANGIOPATHY" | 
                        CAN_DGN_OSTXT == "ISCHEMIC INJURY" | 
                        CAN_DGN_OSTXT == "DIFFUSE CHOLANGIOPATHY" | 
                        CAN_DGN_OSTXT == "BILIARY STRICTURES/CHOLANGIOPATHY" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY POST LIVER TRANSPLANT" | 
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS/BILIARY STRICTURES" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                        CAN_DGN_OSTXT == "ISCHEMIC BILE DUCT DISEASE" | 
                        CAN_DGN_OSTXT == "RECURRENT ISCHEMIC CHOLANGITIS" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K83.8" | 
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS" |
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS S/P OLTX" |
                        CAN_DGN_OSTXT == "BILIARY CHOLANGIOPATHY" | 
                        CAN_DGN_OSTXT == "CHOLANGIOPATHY, RECURRENT CHOLANGITIS" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                        CAN_DGN_OSTXT == "PERSISTENT BILIARY STRICTURE" | 
                        CAN_DGN_OSTXT == "BILIARY STRICTURES" | 
                        CAN_DGN_OSTXT == "ISCHEMIC BILIOPATHY S/P OLT AUGUST 2017" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY OF TRANSPLANTED LIVER" |
                        CAN_DGN_OSTXT == "BILIARY STRICTURE OF TRANSPLANTED LIVER" |
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGO" | 
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS/BILIARY STRICTURES" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                        CAN_DGN_OSTXT == "K75.89 ISHEMIC CHOLANGIOPATHY" |
                        CAN_DGN_OSTXT == "CHOLESTATIC LIVER DISEASE- ISCHEMIC CHOLANGIOPATHY" |
                        CAN_DGN_OSTXT == "ISCHEMIC BILE DUCT DISEASE" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY W/ INFECTED BILOMAS" |
                        CAN_DGN_OSTXT == "RECURRENT ISCHEMIC CHOLANGITIS" | 
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K83.8" | 
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS" |
                        CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS S/P OLTX" |
                        CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K75.89"), 1000, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "FACTOR II DEFICIENCY" |
                        CAN_DGN_OSTXT == "ORNITHINE TRANSCARBAMYLASE DEFICIENCY" |
                        CAN_DGN_OSTXT == "COMPENSATED LIVER CIRRHOSIS 2ND TO WILSON'S DISEAS" |
                        CAN_DGN_OSTXT == "ERYTHROPOIETIC PROTOPORPHYRIA" | 
                        CAN_DGN_OSTXT == "GLYCOGEN STORAGE DISEASE I" | 
                        CAN_DGN_OSTXT == "FAMILIAL RENAL AMYLOIDS FIBRINOGEN A ALPHA CHAIN" | 
                        CAN_DGN_OSTXT == "MNGIE SYNDROME" | 
                        CAN_DGN_OSTXT == "MNGIE" | 
                        CAN_DGN_OSTXT == "MITOCHONDRIAL NEUROGASTROINTESTINAL ENCEPHALOPATHY" | 
                        CAN_DGN_OSTXT == "CARBAMOYL PHOSPHATE DEFICIENCY" | 
                        CAN_DGN_OSTXT == "PROPIONIC ACIDEMIA" | 
                        CAN_DGN_OSTXT == "ORNITHINE TRANSCARBAMYLASE DEFICIENCY" | 
                        CAN_DGN_OSTXT == "OMITHINE TRANSCARBAMYLASE DEFICIENCY" | 
                        CAN_DGN_OSTXT == "ACUTE INTERMITTENT PORPHYRIA" | 
                        CAN_DGN_OSTXT == "VON GIERKE DISEASE" |
                        CAN_DGN_OSTXT == "HYPERCHOLESTEROLEMIA" |
                        CAN_DGN_OSTXT == "FBP: PSEUDO-OBSTRUCTION MYOPATHIC" | 
                        CAN_DGN_OSTXT == "NOONAN'S SYNDROME" | 
                        CAN_DGN_OSTXT == "GLYCOGEN STORAGE DISEASE" | 
                        CAN_DGN_OSTXT == "MAHVASH DISEASE"), 4315, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "NECROSIS IN SETTING OF ACUTE AUTOIMMUNE HEPATITIS" |
                        CAN_DGN_OSTXT == "CHRONIC AUTOIMMUNE HEPATITIS" |
                        CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS^09" |
                        CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS / PBC OVERLAP" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE CHOLESTATIC DISEASE" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGITIS WITH CIRRHOSIS" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGITIS" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGIOPATHY" | 
                        CAN_DGN_OSTXT == "AIH AUTOIMMUNE (POSITIVE ANA, SMA AT OSH)" | 
                        CAN_DGN_OSTXT == "AUTOIMMUNE"), 4212, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "PSC" |
                        CAN_DGN_OSTXT == "RECURRENT PSC" |
                        CAN_DGN_OSTXT == "PRIMARY SCLEROSING CHOLANGITIS" |
                        CAN_DGN_OSTXT == "RIMARY SCLEROSING CHOLANGITIS: NO BOWEL DISEASE"), 4245, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "HEPATOCELLULAR CARCINOMA" |
                        CAN_DGN_OSTXT == "PRIMARY LIVER MALIGNANCY: HEPATOMA, HEPATOCELLULAR" |
                        CAN_DGN_OSTXT == "HCC"), 4400, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "CHOLANGIOCARCINOMA"), 4420, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HEREDITARY HEMOCHROMATOSIS TELANGIECTASIA" |
                        CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIS" |
                        CAN_DGN_OSTXT == "HHT (HEREDITARY HEMORRHAGIC TELANGIECTASIA)" |
                        CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIA" | 
                        CAN_DGN_OSTXT == "HEREDITARY HEMMORRHAGIC TELANGIECTASIAS" |
                        CAN_DGN_OSTXT == "HEMORRHAGIC TELANGIECTASIA" |
                        CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGI" |
                        CAN_DGN_OSTXT == "HHT" |
                        CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELENGECTASIS" |
                        CAN_DGN_OSTXT == "HIV/MULTOPLE AVM'S" |
                        CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIS"), 1001, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS/BILIARY STRICTURE" |
                        CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS" |
                        CAN_DGN_OSTXT == "HAT" |
                        CAN_DGN_OSTXT == "HA ANEURYSM" |
                        CAN_DGN_OSTXT == "VASCULAR COMPROMISE, THROMBOSIS OF HA AND PV" | 
                        CAN_DGN_OSTXT == "HAT/POST-TRANSPLANT ISCHEMIC CHOLANGIOPATHY" |
                        CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS OF TRANSPLANTED LIVER" |
                        CAN_DGN_OSTXT == "S/P LIVER TRANSPLANT; PUTURED HEPATIC ARTERY" |
                        CAN_DGN_OSTXT == "LATE HEPATIC ARTERY THROMBOSIS, RECURRENT" |
                        CAN_DGN_OSTXT == "HEPATIC  ARTERY OCCLUSION"), 1002, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "DELAYED GRAFT FUNCTION" |
                        CAN_DGN_OSTXT == "RETRANSPLANT" |
                        CAN_DGN_OSTXT == "PSEUDO-ANEURYSM WITH HEPATIC NECROSIS" |
                        CAN_DGN_OSTXT == "REJECTION" |
                        CAN_DGN_OSTXT == "BILE DUCT INJURY" | 
                        CAN_DGN_OSTXT == "CHRONIC REJECTION" |
                        CAN_DGN_OSTXT == "CHRONIC DUCTOPENIC REJECTION" |
                        CAN_DGN_OSTXT == "ACUTE CELLULAR REJECTION" |
                        CAN_DGN_OSTXT == "RE-TRANSPLANT/ GRAFT FAILURE" |
                        CAN_DGN_OSTXT == "GRAFT NECROSIS" |
                        CAN_DGN_OSTXT == "GRAFT DYSFUNCTION, HEPATIC VEIN STENOSIS" |
                        CAN_DGN_OSTXT == "GRAFT DYSFUNCTION"), 1003, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "SEC. SCLEROSING CHOLANGITIS" |
                        CAN_DGN_OSTXT == "SECONDARY SCLEROSING CHOLANGITIS" |
                        CAN_DGN_OSTXT == "CHRONIC BILIARY OBSTRUCTION" |
                        CAN_DGN_OSTXT == "CHOLESTATIC COMPLICATIONS POST COVID"), 4260, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HCV CIRRHOSIS" |
                        CAN_DGN_OSTXT == "HEPATITIS C" |
                        CAN_DGN_OSTXT == "HCV" |
                        CAN_DGN_OSTXT == "HEP C" |
                        CAN_DGN_OSTXT == "DECOMPENSATED HCV CIRRHOSIS"), 4204, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN_OSTXT == "RECTAL ADENOCARCINOMA WITH METS TO LIVER" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR WITH METASTASES TO LIVER" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "NEUROENODCRINE TUMOR" |
                       CAN_DGN_OSTXT == "METASTATIC NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "METASTATIC PANCREATIC NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "METASTATIC CARCINOID TUMOR" | 
                       CAN_DGN_OSTXT == "MALIGNANT NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEURO ENDOCRINE  TUMOR" |
                       CAN_DGN_OSTXT == "NEURO ENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR OF LIVER" | 
                       CAN_DGN_OSTXT == "NET" |
                       CAN_DGN_OSTXT == "LIVER METASTASIS NEUROENDOCRINO TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR METASTASZIED TO LIVER" | 
                       CAN_DGN_OSTXT == "METASTATID NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "MALIGNANT CARCINOID TUMOR OF COLON" | 
                       CAN_DGN_OSTXT == "LIVER METS FROM PRIMARY NEUROENDOCINE TUMOR" |
                       CAN_DGN_OSTXT == "LIVER METS FROM PRIMARY NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "PRIMARY PANCREATIC NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "NET METS" |
                       CAN_DGN_OSTXT == "MULTIFOCAL METASTATIC ADENOCAR" |
                       CAN_DGN_OSTXT == "METASTATIC SIGMOID CANCER TO THE LIVER" |
                       CAN_DGN_OSTXT == "METASTATIC MALIGNANT NEUROENDOCRINE TUMOR TO LIVER" | 
                       CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER, CHOLANIOPATHY" | 
                       CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER TO THE LIVER" | 
                       CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER" | 
                       CAN_DGN_OSTXT == "METASTATIC COLON CANCER TO THE LIVER" | 
                       CAN_DGN_OSTXT == "METASTATIC COLON CANCER" | 
                       CAN_DGN_OSTXT == "METASTATIC ACINIC CELL CARCINOMA" | 
                       CAN_DGN_OSTXT == "LIVER ONLY METASTASIS FROM COLON CANCER" | 
                       CAN_DGN_OSTXT == "GIST WITH METASTASIS TO LIVER" | 
                       CAN_DGN_OSTXT == "CRC WITH LIVER METS" | 
                       CAN_DGN_OSTXT == "COLORECTAL LIVER METASTASIS" | 
                       CAN_DGN_OSTXT == "COLORECTAL CANCER WITH METS TO YHE LIVER" |
                       CAN_DGN_OSTXT == "COLORECTAL CANCER WITH LIVER METS" |
                       CAN_DGN_OSTXT == "COLORECTAL CA WITH METS TO LIVER" | 
                       CAN_DGN_OSTXT == "COLORECTAL CA WITH LIVER METS" | 
                       CAN_DGN_OSTXT == "COLON CANCER WITH METS TO THE LIVER" | 
                       CAN_DGN_OSTXT == "COLON CANCER WITH METS TO LIVER" | 
                       CAN_DGN_OSTXT == "COLON CANCER WITH LIVER METASTASIS" |
                       CAN_DGN_OSTXT == "COLON CANCER W METS TO THE LIVER" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE/CARINOID" | 
                       CAN_DGN_OSTXT == "NET" | 
                       CAN_DGN_OSTXT == "COLORECTAL" | 
                       CAN_DGN_OSTXT == "METASTATIC NET" | 
                       CAN_DGN_OSTXT == "PSEUDOPAPILLARY NEOPLASM OF THE PANCREAS" | 
                       CAN_DGN_OSTXT == "COLON ADENOCARCINOMA" | 
                       CAN_DGN_OSTXT == "NEUROENDOCTINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE LIVER METS" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE" | 
                       CAN_DGN_OSTXT == "COLORECTAL LIVER METASTASES" |
                       CAN_DGN_OSTXT == "COLORECTAL WITH METS TO LIVER" |
                       CAN_DGN_OSTXT == "GI STROMAL TUMOR OF STOMACH" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE CARCINOID TUMOR/PANCREATIC ORIGIN" | 
                       CAN_DGN_OSTXT == "RECTAL NET" | 
                       CAN_DGN_OSTXT == "WELL DIFFERENTIATED NEUROENDOCRINE TUMOR METASTATI" | 
                       CAN_DGN_OSTXT == "COLON CANCER WITH METASTASIS TO LIVER" |
                       CAN_DGN_OSTXT == "COLORECTAL METASTASES" |
                       CAN_DGN_OSTXT == "COLORECTAL CANCER" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR WITH METASTASIS TO THE LIVER" | 
                       CAN_DGN_OSTXT == "COLORECTAL CANCER" | 
                       CAN_DGN_OSTXT == "COLON CANCER" | 
                       CAN_DGN_OSTXT == "COLO-RECTAL WITH METS", 1005, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "EPITHELIOID HEMANGIOENDOTHELIOMA" |
                          CAN_DGN_OSTXT == "SOLITARY FIBROUS SARCOMA" |
                          CAN_DGN_OSTXT == "HEMANGIOENDOTHELIAL SARCOMA" |
                          CAN_DGN_OSTXT == "HEPATIC HEMOANGIOMAS" |
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMAS" |
                          CAN_DGN_OSTXT == "HEPATIC ADENOMA" | 
                          CAN_DGN_OSTXT == "EPITHELIOD  ANGIOMYOLIPOMA" | 
                          CAN_DGN_OSTXT == "DONOR METASTATIC MALIGNANT MELANOMA" | 
                          CAN_DGN_OSTXT == "INTRADUCTAL PAPILLARY NEOPLASM OF BILE DUCT" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMA" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMAS" | 
                          CAN_DGN_OSTXT == "EPITHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "ACINAR CELL CARCINOMA- PRIMARY LIVER" | 
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMAS" | 
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "EPITHELIOID ANGIOMYOLIPOMA" | 
                          CAN_DGN_OSTXT == "METASTTIC EPITHELIOID HEMANGOENDOTHELIOMA" |
                          CAN_DGN_OSTXT == "GIANT HEMANGIOMA" |
                          CAN_DGN_OSTXT == "HEMANGIOMA" | 
                          CAN_DGN_OSTXT == "HEPATIC ENDOTHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "EMBRYONAL SARCOMA OF THE LIVER" | 
                          CAN_DGN_OSTXT == "DESMOPLASTIC SMALL ROUND CELL TUMOR" | 
                          CAN_DGN_OSTXT == "MULTIPLE HEPATIC ADENOMAS" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMA"), 4405, CAN_DGN))


timeseriesdata <- timeseriesdata %>% mutate(
  diagnosis = case_when(
    CAN_DGN == 4400 | CAN_DGN == 4401 ~ "Hepatocellular Carcinoma",
    CAN_DGN == 4403 | CAN_DGN == 4420 ~ "Cholangiocarcinoma",
    CAN_DGN == 4451 ~ "Polycystic Liver Disease",
    CAN_DGN == 4104 | CAN_DGN == 4106 | CAN_DGN == 4204 | CAN_DGN == 4206 ~ "Hepatitis C",
    CAN_DGN >= 4215 & CAN_DGN <= 4219 ~ "Alcohol-Associated Liver Disease",
    CAN_DGN >= 4240 & CAN_DGN <= 4245 ~ "Primary Sclerosing Cholangitis",
    CAN_DGN >= 4300 & CAN_DGN <= 4315 ~ "Metabolic Disease",
    CAN_DGN == 4102 | CAN_DGN == 4107 | CAN_DGN == 4202 | CAN_DGN == 4207 ~ "Hepatitis B",
    CAN_DGN == 1005 ~ "Liver Metastases from Other Primary",
    CAN_DGN == 4430 | CAN_DGN == 4402 | CAN_DGN == 4404 | CAN_DGN == 4405 | CAN_DGN == 4410 | CAN_DGN == 4450 | CAN_DGN == 4455 ~ "Other Primary Liver Malignancy",
    CAN_DGN == 4220 ~ "Primary Biliary Cirrhosis",
    CAN_DGN == 4214 ~ "Metabolic Dysfunction-Associated Steatotic Liver Disease",
    CAN_DGN == 4208 | CAN_DGN == 4209 | CAN_DGN == 4210 | CAN_DGN == 4213 ~ "Idiopathic Cirrhosis",
    CAN_DGN == 4212 ~ "Autoimmune Hepatitis",
    CAN_DGN == 1000 | CAN_DGN == 1002 | CAN_DGN == 1003 ~ "Liver Transplant Complications",
    CAN_DGN == 1001 ~ "Vascular Malformations",
    (CAN_DGN >= 4250 & CAN_DGN <= 4275) | (CAN_DGN >= 4230 & CAN_DGN <= 4235) ~ "Other Cholestatic Liver Disease",
    TRUE ~ "Other"),
  diagnosis = factor(diagnosis, levels = c("Hepatocellular Carcinoma", "Cholangiocarcinoma", "Other Primary Liver Malignancy",
                                           "Liver Metastases from Other Primary", "Alcohol-Associated Liver Disease", 
                                           "Metabolic Dysfunction-Associated Steatotic Liver Disease",
                                           "Hepatitis C", "Hepatitis B", "Polycystic Liver Disease", "Primary Sclerosing Cholangitis",
                                           "Primary Biliary Cirrhosis", "Idiopathic Cirrhosis", "Autoimmune Hepatitis",
                                           "Other Cholestatic Liver Disease", "Liver Transplant Complications", "Metabolic Disease",
                                           "Vascular Malformations", "Other"))
)


#Final longitudinal dataset

finaldataset <- finaldataset %>%
  mutate(
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "POLYCYSTIC LIVER DISEASE" |
                          CAN_DGN_OSTXT == "PCLD/PCKD" |
                          CAN_DGN_OSTXT == "POLYCYSTIC LIVER AND KIDNEY DISEASE" |
                          CAN_DGN_OSTXT == "POLYCYSTIC LIVER" | 
                          CAN_DGN_OSTXT == "POLYCYSTIC KIDNEYS" |
                          CAN_DGN_OSTXT == "POLYCYSTIC LIVER / KIDNEY" |
                          CAN_DGN_OSTXT == "POLYCYSTIC KIDNEY DISEASE" |
                          CAN_DGN_OSTXT == "POLYCYSTIC DISEASE" |
                          CAN_DGN_OSTXT == "POLYCYCTIC LIVER" | 
                          CAN_DGN_OSTXT == "AUTOSOMAL DOMINANT POLYCYSTIC LIVER DISEASE?" |  
                          CAN_DGN_OSTXT == "POLYCYSTIC LIVER AND KIDNEY"), 4451, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "NASH" |
                          CAN_DGN_OSTXT == "NAFLD"), 4214, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "CYSTIC FIBROSIS" |
                          CAN_DGN_OSTXT == "CYSTIC FIBROSIS - LIVER"), 4285, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY" |
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGITIS" |
                          CAN_DGN_OSTXT == "DIFFUSE ISCHEMIC CHOLANGIOPATHY" |
                          CAN_DGN_OSTXT == "POST OLT BILIARY STRICTURES" | 
                          CAN_DGN_OSTXT == "ALLOGRAFT FAILURE FROM ISCHEMIC CHOLANGIOPATHY" | 
                          CAN_DGN_OSTXT == "ISCHEMIC INJURY" | 
                          CAN_DGN_OSTXT == "DIFFUSE CHOLANGIOPATHY" | 
                          CAN_DGN_OSTXT == "BILIARY STRICTURES/CHOLANGIOPATHY" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY POST LIVER TRANSPLANT" | 
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS/BILIARY STRICTURES" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                          CAN_DGN_OSTXT == "ISCHEMIC BILE DUCT DISEASE" | 
                          CAN_DGN_OSTXT == "RECURRENT ISCHEMIC CHOLANGITIS" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K83.8" | 
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS" |
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS S/P OLTX" |
                          CAN_DGN_OSTXT == "BILIARY CHOLANGIOPATHY" | 
                          CAN_DGN_OSTXT == "CHOLANGIOPATHY, RECURRENT CHOLANGITIS" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                          CAN_DGN_OSTXT == "PERSISTENT BILIARY STRICTURE" | 
                          CAN_DGN_OSTXT == "BILIARY STRICTURES" | 
                          CAN_DGN_OSTXT == "ISCHEMIC BILIOPATHY S/P OLT AUGUST 2017" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY OF TRANSPLANTED LIVER" |
                          CAN_DGN_OSTXT == "BILIARY STRICTURE OF TRANSPLANTED LIVER" |
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGO" | 
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS/BILIARY STRICTURES" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIO" | 
                          CAN_DGN_OSTXT == "K75.89 ISHEMIC CHOLANGIOPATHY" |
                          CAN_DGN_OSTXT == "CHOLESTATIC LIVER DISEASE- ISCHEMIC CHOLANGIOPATHY" |
                          CAN_DGN_OSTXT == "ISCHEMIC BILE DUCT DISEASE" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY W/ INFECTED BILOMAS" |
                          CAN_DGN_OSTXT == "RECURRENT ISCHEMIC CHOLANGITIS" | 
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K83.8" | 
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS" |
                          CAN_DGN_OSTXT == "RECURRENT CHOLANGITIS S/P OLTX" |
                          CAN_DGN_OSTXT == "ISCHEMIC CHOLANGIOPATHY K75.89"), 1000, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "FACTOR II DEFICIENCY" |
                          CAN_DGN_OSTXT == "ORNITHINE TRANSCARBAMYLASE DEFICIENCY" |
                          CAN_DGN_OSTXT == "COMPENSATED LIVER CIRRHOSIS 2ND TO WILSON'S DISEAS" |
                          CAN_DGN_OSTXT == "ERYTHROPOIETIC PROTOPORPHYRIA" | 
                          CAN_DGN_OSTXT == "GLYCOGEN STORAGE DISEASE I" | 
                          CAN_DGN_OSTXT == "FAMILIAL RENAL AMYLOIDS FIBRINOGEN A ALPHA CHAIN" | 
                          CAN_DGN_OSTXT == "MNGIE SYNDROME" | 
                          CAN_DGN_OSTXT == "MNGIE" | 
                          CAN_DGN_OSTXT == "MITOCHONDRIAL NEUROGASTROINTESTINAL ENCEPHALOPATHY" | 
                          CAN_DGN_OSTXT == "CARBAMOYL PHOSPHATE DEFICIENCY" | 
                          CAN_DGN_OSTXT == "PROPIONIC ACIDEMIA" | 
                          CAN_DGN_OSTXT == "ORNITHINE TRANSCARBAMYLASE DEFICIENCY" | 
                          CAN_DGN_OSTXT == "OMITHINE TRANSCARBAMYLASE DEFICIENCY" | 
                          CAN_DGN_OSTXT == "ACUTE INTERMITTENT PORPHYRIA" | 
                          CAN_DGN_OSTXT == "VON GIERKE DISEASE" |
                          CAN_DGN_OSTXT == "HYPERCHOLESTEROLEMIA" |
                          CAN_DGN_OSTXT == "FBP: PSEUDO-OBSTRUCTION MYOPATHIC" | 
                          CAN_DGN_OSTXT == "NOONAN'S SYNDROME" | 
                          CAN_DGN_OSTXT == "GLYCOGEN STORAGE DISEASE" | 
                          CAN_DGN_OSTXT == "MAHVASH DISEASE"), 4315, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "NECROSIS IN SETTING OF ACUTE AUTOIMMUNE HEPATITIS" |
                          CAN_DGN_OSTXT == "CHRONIC AUTOIMMUNE HEPATITIS" |
                          CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS^09" |
                          CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS / PBC OVERLAP" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE HEPATITIS" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE CHOLESTATIC DISEASE" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGITIS WITH CIRRHOSIS" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGITIS" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE CHOLANGIOPATHY" | 
                          CAN_DGN_OSTXT == "AIH AUTOIMMUNE (POSITIVE ANA, SMA AT OSH)" | 
                          CAN_DGN_OSTXT == "AUTOIMMUNE"), 4212, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "PSC" |
                          CAN_DGN_OSTXT == "RECURRENT PSC" |
                          CAN_DGN_OSTXT == "PRIMARY SCLEROSING CHOLANGITIS" |
                          CAN_DGN_OSTXT == "RIMARY SCLEROSING CHOLANGITIS: NO BOWEL DISEASE"), 4245, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "HEPATOCELLULAR CARCINOMA" |
                          CAN_DGN_OSTXT == "PRIMARY LIVER MALIGNANCY: HEPATOMA, HEPATOCELLULAR" |
                          CAN_DGN_OSTXT == "HCC"), 4400, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "CHOLANGIOCARCINOMA"), 4420, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HEREDITARY HEMOCHROMATOSIS TELANGIECTASIA" |
                          CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIS" |
                          CAN_DGN_OSTXT == "HHT (HEREDITARY HEMORRHAGIC TELANGIECTASIA)" |
                          CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIA" | 
                          CAN_DGN_OSTXT == "HEREDITARY HEMMORRHAGIC TELANGIECTASIAS" |
                          CAN_DGN_OSTXT == "HEMORRHAGIC TELANGIECTASIA" |
                          CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGI" |
                          CAN_DGN_OSTXT == "HHT" |
                          CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELENGECTASIS" |
                          CAN_DGN_OSTXT == "HIV/MULTOPLE AVM'S" |
                          CAN_DGN_OSTXT == "HEREDITARY HEMORRHAGIC TELANGIECTASIS"), 1001, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS/BILIARY STRICTURE" |
                          CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS" |
                          CAN_DGN_OSTXT == "HAT" |
                          CAN_DGN_OSTXT == "HA ANEURYSM" |
                          CAN_DGN_OSTXT == "VASCULAR COMPROMISE, THROMBOSIS OF HA AND PV" | 
                          CAN_DGN_OSTXT == "HAT/POST-TRANSPLANT ISCHEMIC CHOLANGIOPATHY" |
                          CAN_DGN_OSTXT == "HEPATIC ARTERY THROMBOSIS OF TRANSPLANTED LIVER" |
                          CAN_DGN_OSTXT == "S/P LIVER TRANSPLANT; PUTURED HEPATIC ARTERY" |
                          CAN_DGN_OSTXT == "LATE HEPATIC ARTERY THROMBOSIS, RECURRENT" |
                          CAN_DGN_OSTXT == "HEPATIC  ARTERY OCCLUSION"), 1002, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "DELAYED GRAFT FUNCTION" |
                          CAN_DGN_OSTXT == "RETRANSPLANT" |
                          CAN_DGN_OSTXT == "PSEUDO-ANEURYSM WITH HEPATIC NECROSIS" |
                          CAN_DGN_OSTXT == "REJECTION" |
                          CAN_DGN_OSTXT == "BILE DUCT INJURY" | 
                          CAN_DGN_OSTXT == "CHRONIC REJECTION" |
                          CAN_DGN_OSTXT == "CHRONIC DUCTOPENIC REJECTION" |
                          CAN_DGN_OSTXT == "ACUTE CELLULAR REJECTION" |
                          CAN_DGN_OSTXT == "RE-TRANSPLANT/ GRAFT FAILURE" |
                          CAN_DGN_OSTXT == "GRAFT NECROSIS" |
                          CAN_DGN_OSTXT == "GRAFT DYSFUNCTION, HEPATIC VEIN STENOSIS" |
                          CAN_DGN_OSTXT == "GRAFT DYSFUNCTION"), 1003, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "SEC. SCLEROSING CHOLANGITIS" |
                          CAN_DGN_OSTXT == "SECONDARY SCLEROSING CHOLANGITIS" |
                          CAN_DGN_OSTXT == "CHRONIC BILIARY OBSTRUCTION" |
                          CAN_DGN_OSTXT == "CHOLESTATIC COMPLICATIONS POST COVID"), 4260, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 &
                       (CAN_DGN_OSTXT == "HCV CIRRHOSIS" |
                          CAN_DGN_OSTXT == "HEPATITIS C" |
                          CAN_DGN_OSTXT == "HCV" |
                          CAN_DGN_OSTXT == "HEP C" |
                          CAN_DGN_OSTXT == "DECOMPENSATED HCV CIRRHOSIS"), 4204, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN_OSTXT == "RECTAL ADENOCARCINOMA WITH METS TO LIVER" |
                          CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR WITH METASTASES TO LIVER" |
                          CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" |
                          CAN_DGN_OSTXT == "NEUROENODCRINE TUMOR" |
                          CAN_DGN_OSTXT == "METASTATIC NEUROENDOCRINE TUMOR" |
                          CAN_DGN_OSTXT == "METASTATIC PANCREATIC NEUROENDOCRINE TUMOR" |
                          CAN_DGN_OSTXT == "METASTATIC CARCINOID TUMOR" | 
                          CAN_DGN_OSTXT == "MALIGNANT NEUROENDOCRINE TUMOR" | 
                          CAN_DGN_OSTXT == "NEURO ENDOCRINE  TUMOR" |
                          CAN_DGN_OSTXT == "NEURO ENDOCRINE TUMOR" | 
                          CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR OF LIVER" | 
                          CAN_DGN_OSTXT == "NET" |
                          CAN_DGN_OSTXT == "LIVER METASTASIS NEUROENDOCRINO TUMOR" | 
                          CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR METASTASZIED TO LIVER" | 
                          CAN_DGN_OSTXT == "METASTATID NEUROENDOCRINE TUMOR" | 
                          CAN_DGN_OSTXT == "MALIGNANT CARCINOID TUMOR OF COLON" | 
                          CAN_DGN_OSTXT == "LIVER METS FROM PRIMARY NEUROENDOCINE TUMOR" |
                          CAN_DGN_OSTXT == "LIVER METS FROM PRIMARY NEUROENDOCRINE TUMOR" | 
                          CAN_DGN_OSTXT == "PRIMARY PANCREATIC NEUROENDOCRINE TUMOR" |
                          CAN_DGN_OSTXT == "NET METS" |
                          CAN_DGN_OSTXT == "MULTIFOCAL METASTATIC ADENOCAR" |
                          CAN_DGN_OSTXT == "METASTATIC SIGMOID CANCER TO THE LIVER" |
                          CAN_DGN_OSTXT == "METASTATIC MALIGNANT NEUROENDOCRINE TUMOR TO LIVER" | 
                          CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER, CHOLANIOPATHY" | 
                          CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER TO THE LIVER" | 
                          CAN_DGN_OSTXT == "METASTATIC COLORECTAL CANCER" | 
                          CAN_DGN_OSTXT == "METASTATIC COLON CANCER TO THE LIVER" | 
                          CAN_DGN_OSTXT == "METASTATIC COLON CANCER" | 
                          CAN_DGN_OSTXT == "METASTATIC ACINIC CELL CARCINOMA" | 
                          CAN_DGN_OSTXT == "LIVER ONLY METASTASIS FROM COLON CANCER" | 
                          CAN_DGN_OSTXT == "GIST WITH METASTASIS TO LIVER" | 
                          CAN_DGN_OSTXT == "CRC WITH LIVER METS" | 
                          CAN_DGN_OSTXT == "COLORECTAL LIVER METASTASIS" | 
                          CAN_DGN_OSTXT == "COLORECTAL CANCER WITH METS TO YHE LIVER" |
                          CAN_DGN_OSTXT == "COLORECTAL CANCER WITH LIVER METS" |
                          CAN_DGN_OSTXT == "COLORECTAL CA WITH METS TO LIVER" | 
                          CAN_DGN_OSTXT == "COLORECTAL CA WITH LIVER METS" | 
                          CAN_DGN_OSTXT == "COLON CANCER WITH METS TO THE LIVER" | 
                          CAN_DGN_OSTXT == "COLON CANCER WITH METS TO LIVER" | 
                          CAN_DGN_OSTXT == "COLON CANCER WITH LIVER METASTASIS" |
                          CAN_DGN_OSTXT == "COLON CANCER W METS TO THE LIVER" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" |
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE/CARINOID" | 
                       CAN_DGN_OSTXT == "NET" | 
                       CAN_DGN_OSTXT == "COLORECTAL" | 
                       CAN_DGN_OSTXT == "METASTATIC NET" | 
                       CAN_DGN_OSTXT == "PSEUDOPAPILLARY NEOPLASM OF THE PANCREAS" | 
                       CAN_DGN_OSTXT == "COLON ADENOCARCINOMA" | 
                       CAN_DGN_OSTXT == "NEUROENDOCTINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE LIVER METS" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE" | 
                       CAN_DGN_OSTXT == "COLORECTAL LIVER METASTASES" |
                       CAN_DGN_OSTXT == "COLORECTAL WITH METS TO LIVER" |
                       CAN_DGN_OSTXT == "GI STROMAL TUMOR OF STOMACH" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE CARCINOID TUMOR/PANCREATIC ORIGIN" | 
                       CAN_DGN_OSTXT == "RECTAL NET" | 
                       CAN_DGN_OSTXT == "WELL DIFFERENTIATED NEUROENDOCRINE TUMOR METASTATI" | 
                       CAN_DGN_OSTXT == "COLON CANCER WITH METASTASIS TO LIVER" |
                       CAN_DGN_OSTXT == "COLORECTAL METASTASES" |
                       CAN_DGN_OSTXT == "COLORECTAL CANCER" | 
                       CAN_DGN_OSTXT == "NEUROENDOCRINE TUMOR WITH METASTASIS TO THE LIVER" | 
                       CAN_DGN_OSTXT == "COLORECTAL CANCER" | 
                       CAN_DGN_OSTXT == "COLON CANCER" | 
                          CAN_DGN_OSTXT == "COLO-RECTAL WITH METS", 1005, CAN_DGN),
    CAN_DGN = ifelse(CAN_DGN == 999 & 
                       (CAN_DGN_OSTXT == "EPITHELIOID HEMANGIOENDOTHELIOMA" |
                          CAN_DGN_OSTXT == "SOLITARY FIBROUS SARCOMA" |
                          CAN_DGN_OSTXT == "HEMANGIOENDOTHELIAL SARCOMA" |
                          CAN_DGN_OSTXT == "HEPATIC HEMOANGIOMAS" |
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMAS" |
                          CAN_DGN_OSTXT == "HEPATIC ADENOMA" | 
                          CAN_DGN_OSTXT == "EPITHELIOD  ANGIOMYOLIPOMA" | 
                          CAN_DGN_OSTXT == "DONOR METASTATIC MALIGNANT MELANOMA" | 
                          CAN_DGN_OSTXT == "INTRADUCTAL PAPILLARY NEOPLASM OF BILE DUCT" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMA" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMAS" | 
                          CAN_DGN_OSTXT == "EPITHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "ACINAR CELL CARCINOMA- PRIMARY LIVER" | 
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMAS" | 
                          CAN_DGN_OSTXT == "HEPATIC EPITHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "EPITHELIOID ANGIOMYOLIPOMA" | 
                          CAN_DGN_OSTXT == "METASTTIC EPITHELIOID HEMANGOENDOTHELIOMA" |
                          CAN_DGN_OSTXT == "GIANT HEMANGIOMA" |
                          CAN_DGN_OSTXT == "HEMANGIOMA" | 
                          CAN_DGN_OSTXT == "HEPATIC ENDOTHELIOID HEMANGIOENDOTHELIOMA" | 
                          CAN_DGN_OSTXT == "EMBRYONAL SARCOMA OF THE LIVER" | 
                          CAN_DGN_OSTXT == "DESMOPLASTIC SMALL ROUND CELL TUMOR" | 
                          CAN_DGN_OSTXT == "MULTIPLE HEPATIC ADENOMAS" | 
                          CAN_DGN_OSTXT == "HEPATIC HEMANGIOMA"), 4405, CAN_DGN))

#Final dataset with just one observation per patient

finaldataset <- finaldataset %>% mutate(
  diagnosis = case_when(
    CAN_DGN == 4400 | CAN_DGN == 4401 ~ "Hepatocellular Carcinoma",
    CAN_DGN == 4403 | CAN_DGN == 4420 ~ "Cholangiocarcinoma",
    CAN_DGN == 4451 ~ "Polycystic Liver Disease",
    CAN_DGN == 4104 | CAN_DGN == 4106 | CAN_DGN == 4204 | CAN_DGN == 4206 ~ "Hepatitis C",
    CAN_DGN >= 4215 & CAN_DGN <= 4219 ~ "Alcohol-Associated Liver Disease",
    CAN_DGN >= 4240 & CAN_DGN <= 4245 ~ "Primary Sclerosing Cholangitis",
    CAN_DGN >= 4300 & CAN_DGN <= 4315 ~ "Metabolic Disease",
    CAN_DGN == 4102 | CAN_DGN == 4107 | CAN_DGN == 4202 | CAN_DGN == 4207 ~ "Hepatitis B",
    CAN_DGN == 1005 ~ "Liver Metastases from Other Primary",
    CAN_DGN == 4430 | CAN_DGN == 4402 | CAN_DGN == 4404 | CAN_DGN == 4405 | CAN_DGN == 4410 | CAN_DGN == 4450 | CAN_DGN == 4455 ~ "Other Primary Liver Malignancy",
    CAN_DGN == 4220 ~ "Primary Biliary Cirrhosis",
    CAN_DGN == 4214 ~ "Metabolic Dysfunction-Associated Steatotic Liver Disease",
    CAN_DGN == 4208 | CAN_DGN == 4209 | CAN_DGN == 4210 | CAN_DGN == 4213 ~ "Idiopathic Cirrhosis",
    CAN_DGN == 4212 ~ "Autoimmune Hepatitis",
    CAN_DGN == 1000 | CAN_DGN == 1002 | CAN_DGN == 1003 ~ "Liver Transplant Complications",
    CAN_DGN == 1001 ~ "Vascular Malformations",
    (CAN_DGN >= 4250 & CAN_DGN <= 4275) | (CAN_DGN >= 4230 & CAN_DGN <= 4235) ~ "Other Cholestatic Liver Disease",
    TRUE ~ "Other"),
  diagnosis = factor(diagnosis, levels = c("Alcohol-Associated Liver Disease", "Hepatocellular Carcinoma",
                                           "Metabolic Dysfunction-Associated Steatotic Liver Disease",
                                           "Liver Metastases from Other Primary",
                                           "Hepatitis C", "Hepatitis B", "Polycystic Liver Disease", "Primary Sclerosing Cholangitis",
                                           "Primary Biliary Cirrhosis", "Idiopathic Cirrhosis", "Autoimmune Hepatitis",
                                           "Other Cholestatic Liver Disease", "Liver Transplant Complications", "Metabolic Disease",
                                           "Cholangiocarcinoma", "Other Primary Liver Malignancy", "Vascular Malformations", "Other")))



```
